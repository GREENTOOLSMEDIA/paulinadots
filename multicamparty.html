<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Paulina Dots Multicam Party</title>
  <style>
    html, body {
      margin: 0; padding: 0; height: 100%; background: black; overflow: hidden;
    }
    #startOverlay {
      position: fixed; inset: 0;
      background: transparent;
      z-index: 10;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
    }
    #startOverlay img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      pointer-events: none;
    }
    .gallery {
      position: fixed; inset: 0;
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      grid-template-rows: repeat(4, 1fr);
      gap: 2px;
      width: 100vw;
      height: 100vh;
      z-index: 1;
      background: black;
    }
    .video-card {
      position: relative;
      width: 100%;
      height: 100%;
      background: black;
      cursor: pointer;
    }
    iframe {
      width: 100%;
      height: 100%;
      border: none;
      background: black;
      pointer-events: none; /* Desactivado por defecto para que no se pueda clickear y solo se use el div padre */
    }
    .video-card.active iframe {
      pointer-events: auto; /* Solo el video activo permite interacción */
    }
  </style>
</head>
<body>

  <div id="startOverlay">
    <img src="images/paulinadots-multicam-party.png" alt="Start Multicam Party" />
  </div>

  <div id="gallery" class="gallery"></div>

  <script>
    const API_KEY = 'AIzaSyByMsug3oecDQUYP3lMrUuZ2qxLsCtatGs';
    const PLAYLIST_ID = 'PLKVS65BaeC53W4tv9yH7-ax3b0SNMhH8m';
    const MAX_RESULTS_API = 50;
    const MAX_RESULTS = 16;

    const gallery = document.getElementById('gallery');
    const overlay = document.getElementById('startOverlay');

    let players = [];
    let activeIndex = null;

    // Crear iframe sin autoplay ni mute ni loop, sin controles visibles, solo para carga inicial
    function createIframe(videoId) {
      const iframe = document.createElement('iframe');
      iframe.src = `https://www.youtube.com/embed/${videoId}?enablejsapi=1&rel=0&controls=0&autoplay=0&loop=0&modestbranding=1&showinfo=0&iv_load_policy=3`;
      iframe.allow = 'autoplay; encrypted-media';
      iframe.setAttribute('data-id', videoId);
      return iframe;
    }

    // Envía comandos a iframe para reproducir o pausar video
    function postMessageToIframe(iframe, command) {
      iframe.contentWindow.postMessage(JSON.stringify({
        event: 'command',
        func: command,
        args: []
      }), '*');
    }

    // Activar video (reproducir y mostrar controles)
    function activateVideo(index) {
      if (activeIndex !== null && players[activeIndex]) {
        // Pausar video activo anterior y ocultar controles
        postMessageToIframe(players[activeIndex].iframe, 'pauseVideo');
        players[activeIndex].card.classList.remove('active');
        // Ocultar controles: recargar iframe sin controles para dejarlo limpio
        players[activeIndex].iframe.src = players[activeIndex].videoSrcClean;
      }
      activeIndex = index;
      const player = players[index];
      player.card.classList.add('active');
      // Recargar iframe con controles y autoplay
      player.iframe.src = player.videoSrcWithControls;
      // Esperar a que el iframe cargue para enviar play (por si no autoplaya automáticamente)
      setTimeout(() => {
        postMessageToIframe(player.iframe, 'playVideo');
      }, 500);
    }

    async function fetchVideos() {
      try {
        const res = await fetch(`https://www.googleapis.com/youtube/v3/playlistItems?part=snippet&maxResults=${MAX_RESULTS_API}&playlistId=${PLAYLIST_ID}&key=${API_KEY}`);
        const data = await res.json();
        const items = data.items || [];
        // Elegir 16 videos aleatorios
        const shuffled = items.sort(() => 0.5 - Math.random());
        const selected = shuffled.slice(0, MAX_RESULTS);

        selected.forEach((item, i) => {
          const videoId = item.snippet.resourceId.videoId;
          const card = document.createElement('div');
          card.className = 'video-card';

          // iframe sin controles para cargar
          const iframeClean = createIframe(videoId);

          // Iframe con controles para activar al reproducir
          const videoSrcWithControls = `https://www.youtube.com/embed/${videoId}?enablejsapi=1&rel=0&controls=1&autoplay=1&loop=0&modestbranding=1&showinfo=0&iv_load_policy=3`;

          players.push({
            card,
            iframe: iframeClean,
            videoId,
            videoSrcClean: iframeClean.src,
            videoSrcWithControls,
          });

          card.appendChild(iframeClean);
          gallery.appendChild(card);

          // Click en tarjeta activa video
          card.addEventListener('click', () => {
            activateVideo(i);
          });
        });
      } catch (error) {
        console.error('Error cargando videos:', error);
        gallery.innerHTML = '<p style="color:white; text-align:center;">Error cargando videos. Intenta más tarde.</p>';
      }
    }

    // Al hacer click en overlay, quitarlo y activar un video aleatorio
    overlay.addEventListener('click', () => {
      overlay.style.display = 'none';
      if (players.length > 0) {
        const randomIndex = Math.floor(Math.random() * players.length);
        activateVideo(randomIndex);
      }
    });

    fetchVideos();
  </script>
</body>
</html>
